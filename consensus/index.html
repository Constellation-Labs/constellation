<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="canonical" href="https://constellation-labs.github.io/constellation/consensus/">
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Consensus - Constellation Documentation</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Consensus";
    var mkdocs_page_input_path = "consensus.md";
    var mkdocs_page_url = "/constellation/consensus/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Constellation Documentation</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Introduction</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../architecture/">Architecture</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Consensus</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#architecture">Architecture</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#glossary">Glossary</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#consensus-round">Consensus round</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#stages">Stages</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#1-start-consensus">1. Start consensus</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#2-broadcast-and-gather-consensus-data-proposals">2. Broadcast and gather consensus data proposals</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#3-merge-broadcast-and-gather-consensus-block-proposals">3. Merge, broadcast and gather consensus block proposals</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#4-select-majority-block-proposal-and-merge-facilitators-signatures">4. Select majority block proposal and merge facilitator's signatures</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#5-accepted-finished-block-and-broadcast-to-non-facilitators">5. Accepted finished block and broadcast to non-facilitators</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#clean-up">Clean up</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#errors">Errors</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#configuration">Configuration</a>
    </li>
    </ul>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../design-choices/">Design choices</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../running-a-node/">Running a node</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Constellation Documentation</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Consensus</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/Constellation-Labs/constellation/edit/dev/docs-gh-pages/consensus.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h2 id="consensus">Consensus</h2>
<h3 id="architecture">Architecture</h3>
<p>Every new <code>CheckpointBlock</code> is being created under a consensus round.</p>
<h3 id="glossary">Glossary</h3>
<ul>
<li><strong>consensus owner</strong> - the node which sent consensus proposal to others and initiated a new round</li>
<li><strong>facilitator</strong> - node which has been selected to take part in a new round and responded successfully to participate in it (including owner)</li>
<li><strong>SOE</strong> - signed observation edge</li>
<li><strong>data proposal</strong> - transactions (and other checkpoint block data) proposed by the facilitator to include in the new consensus round</li>
</ul>
<h3 id="consensus-round">Consensus round</h3>
<ol>
<li>Start consensus</li>
<li>Broadcast and gather consensus data proposals</li>
<li>Merge, broadcast and gather consensus block proposals</li>
<li>Select majority block proposal and merge facilitators' signatures</li>
<li>Accepted finished block and broadcast to non-facilitators</li>
</ol>
<h3 id="stages">Stages</h3>
<h4 id="1-start-consensus">1. Start consensus</h4>
<p><code>ConsensusScheduler</code> runs <code>consensusManager.startOwnConsensus()</code> every <strong>n</strong> seconds
(<em>default value: 10s</em>, configurable under <code>constellation.consensus.start-own-interval</code>).
To start a new round, node must be in one of valid node states. Otherwise, creating new round will be skipped.
Valid node states for starting new consensus round are <strong>Ready</strong> and <strong>SnapshotCreation</strong>.</p>
<p>When new round can be created, owner creates one using pending transactions (up to <code>maxTransactionThreshold</code>), tip SOE
and selects final facilitators. Peers which can take part in the consensus round must have <strong>nextSnapshotHeight</strong> above
the proposed tip. Otherwise, the selected node will not be able to accept the final checkpoint block. Facilitators are being
selected randomly taking into account above preconditions.</p>
<h4 id="2-broadcast-and-gather-consensus-data-proposals">2. Broadcast and gather consensus data proposals</h4>
<p>Owner sends the <code>NotifyFacilitators</code> message to all selected facilitators and waits for the response. If facilitator is able
to start a consensus, responds with success message and creates a corresponding round. Facilitator cannot start a consensus
if proposed tip is above the current snapshot height or is in the incorrect state (i.e. leaving from the cluster).
When all facilitators have been notified and started rounds successfully, each one pulls transactions, similarly as owner did,
and broadcasts it to all consensus round's participants. In parallel, each participant gathers proposals from others and keeps it locally.</p>
<h4 id="3-merge-broadcast-and-gather-consensus-block-proposals">3. Merge, broadcast and gather consensus block proposals</h4>
<p>When node received all proposals, it merges them together to create a block proposal and then broadcasts it to others.
Such a block proposal is signed by the proposer only.</p>
<h4 id="4-select-majority-block-proposal-and-merge-facilitators-signatures">4. Select majority block proposal and merge facilitator's signatures</h4>
<p>When node received all block proposals, it verifies the correctness of proposals. The majority block is being chosen
and all edges from corresponding blocks are merged together creating one block with all signatures. Such a block
is broadcasted to other facilitators as <strong>selected</strong> one.</p>
<h4 id="5-accepted-finished-block-and-broadcast-to-non-facilitators">5. Accepted finished block and broadcast to non-facilitators</h4>
<p>When node received confirmation from other participants that the selected block is the same across all facilitators,
it starts acceptance flow for the selected block. If block has been accepted successfully, node broadcasts it to all non-facilitators.
It simply means that every other node in the network receives the newly created block and tries to accept it.</p>
<h3 id="clean-up">Clean up</h3>
<p>Every own and participating consensus round has a total timeout specified by <code>form-checkpoint-blocks-timeout</code> configuration entry.
If the round takes longer or basically stopped at some point, the cleaning process will close such round. Transactions
and observations proposed in the round will be taken back to the pool and proposed in another round. The same applies if consensus
round has been finished with an error.</p>
<h3 id="errors">Errors</h3>
<ul>
<li><code>OwnRoundAlreadyInProgress</code> - cannot start a new round because another own one is in progress</li>
<li><code>NoTipsForConsensus</code> - there are no tips to start a new round</li>
<li><code>NoPeersForConsensus</code> - there are no peers to start a new round with</li>
<li><code>NotAllPeersParticipate</code> - one of selected facilitator rejected participating in the round
(i.e. when proposed tip is above the latest created snapshot height) </li>
<li><code>NotEnoughProposals</code> - if node received fewer proposals than expected</li>
</ul>
<h3 id="configuration">Configuration</h3>
<pre><code class="hocon">consensus {
    maxTransactionThreshold = 50
    maxObservationThreshold = 50
    start-own-interval = 5s
    cleanup-interval = 10s
    union-proposals-timeout = 10s
    checkpoint-block-resolve-majority-timeout = 10s
    accept-resolved-majority-block-timeout = 10s
    form-checkpoint-blocks-timeout = 40s
  }
</code></pre>

<ul>
<li><code>maxTransactionThreshold</code> (<em>default</em>: <strong>50</strong>) - maximum transactions that can be pulled to one round</li>
<li><code>maxObservationThreshold</code> (<em>default</em>: <strong>50</strong>) - maximum observations that can be pulled to one round</li>
<li><code>start-own-interval</code> (<em>default</em>: <strong>5s</strong>) - how often trigger creating new round</li>
<li><code>cleanup-interval</code> (<em>default</em>: <strong>10s</strong>) - how often trigger cleaning up flow</li>
<li><code>union-proposals-timeout</code> (<em>default</em>: <strong>10s</strong>) - timeout for gathering data proposals</li>
<li><code>checkpoint-block-resolve-majority-timeout</code> (<em>default</em>: <strong>10s</strong>) - timeout for gathering block proposals</li>
<li><code>form-checkpoint-blocks-timeout</code> (<em>default</em>: <strong>40s</strong>) - timeout for the whole consensus round</li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../design-choices/" class="btn btn-neutral float-right" title="Design choices">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../architecture/" class="btn btn-neutral" title="Architecture"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/Constellation-Labs/constellation/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../architecture/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../design-choices/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
